{% extends "base.html" %}

{% block title %}File Details - RepoSync{% endblock %}

{% block app_content %}
<div class="file-detail">
    <div class="page-header">
        <div>
            <a href="#" id="backLink" class="back-link">
                <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
                Back to Project
            </a>
            <h1 id="fileName">Loading...</h1>
            <p id="fileStatus" class="status-badge"></p>
        </div>
        <div class="file-actions-header">
            <button id="checkoutBtn" class="btn btn-secondary" onclick="checkoutFile()" style="display:none;">
                <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15V3m0 12l-4-4m4 4l4-4M2 17l.621 2.485A2 2 0 004.561 21h14.878a2 2 0 001.94-1.515L22 17"/>
                </svg>
                Checkout
            </button>
            <button id="checkinBtn" class="btn btn-primary" onclick="showCheckinModal()" style="display:none;">
                <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                </svg>
                Check In
            </button>
            <button id="downloadBtn" class="btn btn-secondary" onclick="downloadFile()">
                <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                Download
            </button>
        </div>
    </div>

    <div class="file-info-section">
        <h2>File Information</h2>
        <div id="fileInfo" class="info-grid">
            <!-- File info will be loaded here -->
        </div>
    </div>

    <div class="versions-section">
        <h2>Version History</h2>
        <div id="versionsList" class="versions-list">
            <!-- Versions will be loaded here -->
        </div>
    </div>
</div>

<!-- Check In Modal -->
<div id="checkinModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close" onclick="hideCheckinModal()">&times;</span>
        <h2>Check In File</h2>
        <form id="checkinForm" enctype="multipart/form-data">
            <div class="form-group">
                <label for="checkinFile">Updated Excel File</label>
                <input type="file" id="checkinFile" accept=".xlsx,.xlsm,.xls" required>
            </div>
            <div class="form-group">
                <label for="checkinMessage">Commit Message *</label>
                <input type="text" id="checkinMessage" required>
            </div>
            <button type="submit" class="btn btn-primary">Check In</button>
        </form>
        <div id="checkinError" class="error-message"></div>
    </div>
</div>

<script>
const fileId = {{ file_id }};
let fileData = null;

document.addEventListener('DOMContentLoaded', loadFile);

async function loadFile() {
    try {
        const response = await fetch(`/api/files/${fileId}`);
        const data = await response.json();
        
        if (response.ok) {
            fileData = data.file;
            renderFileDetails(fileData);
        } else {
            alert('Failed to load file');
        }
    } catch (error) {
        console.error('Error loading file:', error);
    }
}

function renderFileDetails(file) {
    document.getElementById('fileName').textContent = file.filename;
    document.getElementById('backLink').href = `/projects/${file.project_id}`;
    
    const statusEl = document.getElementById('fileStatus');
    statusEl.textContent = file.status;
    statusEl.className = `status-badge status-${file.status}`;
    
    document.getElementById('fileInfo').innerHTML = `
        <div><strong>Current Version:</strong> ${file.current_version}</div>
        <div><strong>Created:</strong> ${new Date(file.created_at).toLocaleString()}</div>
        <div><strong>Last Updated:</strong> ${new Date(file.updated_at).toLocaleString()}</div>
        <div><strong>Status:</strong> ${file.status}</div>
        ${file.checked_out_by ? `<div><strong>Checked Out By:</strong> ${file.checked_out_by}</div>` : ''}
    `;
    
    // Show/hide action buttons based on status
    const checkoutBtn = document.getElementById('checkoutBtn');
    const checkinBtn = document.getElementById('checkinBtn');
    
    if (file.status === 'available') {
        checkoutBtn.style.display = 'inline-block';
        checkinBtn.style.display = 'none';
    } else if (file.is_checked_out_by_me) {
        checkoutBtn.style.display = 'none';
        checkinBtn.style.display = 'inline-block';
    }
    
    renderVersions(file.versions || []);
}

function renderVersions(versions) {
    const versionsList = document.getElementById('versionsList');
    versionsList.innerHTML = versions.map(v => `
        <div class="version-item">
            <div class="version-info">
                <strong>Version ${v.version_number}</strong>
                <span>${new Date(v.created_at).toLocaleString()}</span>
            </div>
            <p>${v.commit_message || 'No message'}</p>
            <small>By ${v.uploaded_by}</small>
        </div>
    `).join('');
}

async function checkoutFile() {
    try {
        const response = await fetch(`/api/files/${fileId}/checkout`, { method: 'POST' });
        if (response.ok) {
            loadFile();
        } else {
            const data = await response.json();
            alert(data.error || 'Checkout failed');
        }
    } catch (error) {
        alert('An error occurred');
    }
}

async function downloadFile() {
    window.location.href = `/api/files/${fileId}/download`;
}

function showCheckinModal() {
    document.getElementById('checkinModal').style.display = 'block';
}

function hideCheckinModal() {
    document.getElementById('checkinModal').style.display = 'none';
    document.getElementById('checkinForm').reset();
}

document.getElementById('checkinForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData();
    formData.append('file', document.getElementById('checkinFile').files[0]);
    formData.append('commit_message', document.getElementById('checkinMessage').value);
    
    try {
        const response = await fetch(`/api/files/${fileId}/checkin`, {
            method: 'POST',
            body: formData
        });
        if (response.ok) {
            hideCheckinModal();
            loadFile();
        } else {
            const data = await response.json();
            document.getElementById('checkinError').textContent = data.error || 'Check-in failed';
        }
    } catch (error) {
        document.getElementById('checkinError').textContent = 'An error occurred';
    }
});
</script>
{% endblock %}

